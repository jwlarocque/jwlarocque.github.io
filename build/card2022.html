<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="./favicon.png" />
		<link rel="stylesheet" href="./global.css"/>
		<meta name="viewport" content="width=device-width" />
		<meta http-equiv="content-security-policy" content="">
		<link href="./_app/immutable/assets/_page-d8cf9612.css" rel="stylesheet">
		<link href="./_app/immutable/assets/Nav-ca9f13de.css" rel="stylesheet">
		<link rel="modulepreload" href="./_app/immutable/start-882da48e.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/index-dbc3e342.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/singletons-eedebeb3.js">
		<link rel="modulepreload" href="./_app/immutable/components/layout.svelte-44d6b710.js">
		<link rel="modulepreload" href="./_app/immutable/components/pages/card2022/_page.svelte-c3c2733c.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/Nav-6c9e44cd.js">
		<link rel="modulepreload" href="./_app/immutable/modules/pages/card2022/_page.ts-9fba1343.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/_page-9590e0cc.js">
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">


<nav class="svelte-8exw55"><h1 class="current svelte-8exw55">2022 Christmas Card</h1>
    
    <hr class="svelte-8exw55"></nav>

<main id="main" class="svelte-1gtiks3">

<main class="svelte-174w8db"><div id="slide" class="svelte-174w8db"><div id="imgContainer" class="svelte-174w8db"><img src="card2022/img/0_generate.png" alt="" style="z-index: 9" class=" svelte-174w8db"><img src="card2022/img/1_outline_mask.png" alt="" style="z-index: 8" class=" svelte-174w8db"><img src="card2022/img/2_outline_paths.png" alt="" style="z-index: 7" class=" svelte-174w8db"><img src="card2022/img/3_smoothed_paths.svg" alt="" style="z-index: 6" class=" svelte-174w8db"><img src="card2022/img/0_generate.png" alt="" style="z-index: 5" class=" svelte-174w8db"><img src="card2022/img/5_shading_quantize.png" alt="" style="z-index: 4" class=" svelte-174w8db"><img src="card2022/img/6_shading_masks.png" alt="" style="z-index: 3" class=" svelte-174w8db"><img src="card2022/img/7_all_hatched.svg" alt="" style="z-index: 2" class=" svelte-174w8db"><img src="card2022/img/8_plotting.svg" alt="" style="z-index: 1" class=" svelte-174w8db"></div>
        <div id="controls" class="svelte-174w8db"><p class="svelte-174w8db"><span href="#0" class="svelte-174w8db">Prev
                </span>
                
                <span class="svelte-174w8db">Next
                </span></p>
            <p id="pageNum" class="svelte-174w8db">1 / 9</p></div></div>
    <div id="desc" class="svelte-174w8db"><div class="currDesc svelte-174w8db" id="0"><!-- HTML_TAG_START --><h3>Image Generation</h3>
<p>
    The image depicted on the card was generated by the text-to-image deep learning model <a href="https://stability.ai/blog/stable-diffusion-public-release">Stable Diffusion</a> (v1.5).  I prompted the model for images of "Christmas stars" in an ink illustrated style.
</p>
<p>
    In hindsight it was difficult to extract the "inked" lines from this image, and it probably would've been easier to try to generate an unstylized image and allow the style to arise from the plotting process.<br/>Anyways.
</p><!-- HTML_TAG_END -->
            </div><div class=" svelte-174w8db" id="1"><!-- HTML_TAG_START --><h3>Outline Vectorization</h3>
<p>
    I wanted to emphasize the lines in the image by converting them to vectors which the pen plotter could draw directly, rather than using a shading technique intended for plotting photographs. There are lots of existing tools in this area but they weren't well suited to this image, either performing poorly in terms of accuracy or producing geometry too complex to be drawn.
</p>
<div class="indented">
        <p>
            To isolate the pixels which were part of "ink" lines, I applied a Gaussian blur to the image and took pixels which became significantly lighter. As you can see this also picks up some pixels which are merely part of a dark region adjacent to a lighter one, but I was more interested in cleanliness than accuracy.
        </p>
</div><!-- HTML_TAG_END -->
            </div><div class=" svelte-174w8db" id="2"><!-- HTML_TAG_START --><div class="indented">
    <p>
        The low resolution of the source image (512x512) and consequent fine- and disjointedness of the its lines made it difficult to apply the existing line vectorization algorithms I tried (e.g. <a href="http://dx.doi.org/10.1109/34.754586">Sparse Pixel Vectorization</a>). 
    </p>
    <p>
        I ended up implementing a simple greedy tracing method which performed okay on this image. It creates a path starting at a random pixel from the previous step and looks for nearby pixels which maximize the proportion of the vector between the current and candidate next pixel which is in the direction of the vector between the previous and current pixel, divided by the distance to the next pixel (so, <span class="code">dot(bc,&nbspab)&nbsp/&nbspdot(bc,&nbspbc)</span>).
        <br/>
        This strategy could be made a bit less greedy by searching more than one pixel ahead or by applying some optimization to the traced paths, but it was good enough as-is.
    </p>
</div>
<!-- HTML_TAG_END -->
            </div><div class=" svelte-174w8db" id="3"><!-- HTML_TAG_START --><div class="indented">
    <p>
        To smooth out the jagged lines created from the integer pixel coordinates I applied <span class="code">scipy</span>'s <span class="code">UnivariateSpline</span> interpolation to each axis of each of the paths. The result is the final SVG which will be plotted onto the card.
    </p>
</div><!-- HTML_TAG_END -->
            </div><div class=" svelte-174w8db" id="4"><!-- HTML_TAG_START --><h3>Shading and Color</h3>
<p>
    I found the plotted outline alone to be busy and difficult to parse, so I added shading in three segments to bring color to the card and break up the image into distinct parts.
</p>
<p>
    Here's the original image again for reference.
</p><!-- HTML_TAG_END -->
            </div><div class=" svelte-174w8db" id="5"><!-- HTML_TAG_START --><div class="indented">
    <p>
        First the image was quantized into four colors with OpenCV's k-means clustering function. I then used each color to mask off a segment of the image to be shaded with a pen of a different color.
    </p>
</div><!-- HTML_TAG_END -->
            </div><div class=" svelte-174w8db" id="6"><!-- HTML_TAG_START --><div class="indented">
    <p>
        The dark "outline" segment was discarded, and the blue parts of the foreground manually combined with the grey to give a single "ground" segment.  
        <br/>
        I also masked the segments near the outline vectors to help prevent overlap due to imprecise plotting.
    </p>
</div><!-- HTML_TAG_END -->
            </div><div class=" svelte-174w8db" id="7"><!-- HTML_TAG_START --><div class="indented">
    <p>
        Finally, the raster segments were vectorized with the <a href="https://github.com/plottertools/hatched"><span class="code">hatched</span> package</a>
        <br/>
        The concentric circular hatching offered by that tool reminded me of the star trails created by long exposure night photography, so I chose to use that for the sky.
    </p>
</div><!-- HTML_TAG_END -->
            </div><div class=" svelte-174w8db" id="8"><!-- HTML_TAG_START --><h3>Plotting It All Together <span style="font-size: 0.78em; font-weight: 400;">(Ahaha.)</span></h3>
<p>
    That's it! Here's the combined SVG plotted to the card. I removed the stars/snowflakes (I don't think the model could decide what they were) from the outline layer as they were too small to plot effectively and just added confusion to the sky.
</p>
<p>
    This SVG was combined with the "Merry Christmas" text in Inkscape and converted to gcode with the <a href="https://github.com/plottertools/vpype-gcode"><span class="code">vpype-gcode</span></a> plugin for vpype.  
    <br/>
    I then went in and manually broke the gcode up into four files for more flexibility when plotting.
</p><!-- HTML_TAG_END -->
            </div></div></main></main>


		<script type="module" data-sveltekit-hydrate="1g741yl">
			import { start } from "./_app/immutable/start-882da48e.js";

			start({
				env: {},
				paths: {"base":"","assets":""},
				target: document.querySelector('[data-sveltekit-hydrate="1g741yl"]').parentNode,
				version: "1671432292398",
				hydrate: {
					node_ids: [0, 3],
					data: [null,null],
					form: null
				}
			});
		</script>
	<script type="application/json" data-sveltekit-fetched data-url="/card2022/desc/0_generate.html">{"status":200,"statusText":"","headers":{},"body":"\u003Ch3>Image Generation\u003C/h3>\r\n\u003Cp>\r\n    The image depicted on the card was generated by the text-to-image deep learning model \u003Ca href=\"https://stability.ai/blog/stable-diffusion-public-release\">Stable Diffusion\u003C/a> (v1.5).  I prompted the model for images of \"Christmas stars\" in an ink illustrated style.\r\n\u003C/p>\r\n\u003Cp>\r\n    In hindsight it was difficult to extract the \"inked\" lines from this image, and it probably would've been easier to try to generate an unstylized image and allow the style to arise from the plotting process.\u003Cbr/>Anyways.\r\n\u003C/p>"}</script>
	<script type="application/json" data-sveltekit-fetched data-url="/card2022/desc/1_outline_mask.html">{"status":200,"statusText":"","headers":{},"body":"\u003Ch3>Outline Vectorization\u003C/h3>\r\n\u003Cp>\r\n    I wanted to emphasize the lines in the image by converting them to vectors which the pen plotter could draw directly, rather than using a shading technique intended for plotting photographs. There are lots of existing tools in this area but they weren't well suited to this image, either performing poorly in terms of accuracy or producing geometry too complex to be drawn.\r\n\u003C/p>\r\n\u003Cdiv class=\"indented\">\r\n        \u003Cp>\r\n            To isolate the pixels which were part of \"ink\" lines, I applied a Gaussian blur to the image and took pixels which became significantly lighter. As you can see this also picks up some pixels which are merely part of a dark region adjacent to a lighter one, but I was more interested in cleanliness than accuracy.\r\n        \u003C/p>\r\n\u003C/div>"}</script>
	<script type="application/json" data-sveltekit-fetched data-url="/card2022/desc/2_outline_paths.html">{"status":200,"statusText":"","headers":{},"body":"\u003Cdiv class=\"indented\">\r\n    \u003Cp>\r\n        The low resolution of the source image (512x512) and consequent fine- and disjointedness of the its lines made it difficult to apply the existing line vectorization algorithms I tried (e.g. \u003Ca href=\"http://dx.doi.org/10.1109/34.754586\">Sparse Pixel Vectorization\u003C/a>). \r\n    \u003C/p>\r\n    \u003Cp>\r\n        I ended up implementing a simple greedy tracing method which performed okay on this image. It creates a path starting at a random pixel from the previous step and looks for nearby pixels which maximize the proportion of the vector between the current and candidate next pixel which is in the direction of the vector between the previous and current pixel, divided by the distance to the next pixel (so, \u003Cspan class=\"code\">dot(bc,&nbspab)&nbsp/&nbspdot(bc,&nbspbc)\u003C/span>).\r\n        \u003Cbr/>\r\n        This strategy could be made a bit less greedy by searching more than one pixel ahead or by applying some optimization to the traced paths, but it was good enough as-is.\r\n    \u003C/p>\r\n\u003C/div>\r\n"}</script>
	<script type="application/json" data-sveltekit-fetched data-url="/card2022/desc/3_smoothed_paths.html">{"status":200,"statusText":"","headers":{},"body":"\u003Cdiv class=\"indented\">\r\n    \u003Cp>\r\n        To smooth out the jagged lines created from the integer pixel coordinates I applied \u003Cspan class=\"code\">scipy\u003C/span>'s \u003Cspan class=\"code\">UnivariateSpline\u003C/span> interpolation to each axis of each of the paths. The result is the final SVG which will be plotted onto the card.\r\n    \u003C/p>\r\n\u003C/div>"}</script>
	<script type="application/json" data-sveltekit-fetched data-url="/card2022/desc/4_shading.html">{"status":200,"statusText":"","headers":{},"body":"\u003Ch3>Shading and Color\u003C/h3>\r\n\u003Cp>\r\n    I found the plotted outline alone to be busy and difficult to parse, so I added shading in three segments to bring color to the card and break up the image into distinct parts.\r\n\u003C/p>\r\n\u003Cp>\r\n    Here's the original image again for reference.\r\n\u003C/p>"}</script>
	<script type="application/json" data-sveltekit-fetched data-url="/card2022/desc/5_shading_quantize.html">{"status":200,"statusText":"","headers":{},"body":"\u003Cdiv class=\"indented\">\r\n    \u003Cp>\r\n        First the image was quantized into four colors with OpenCV's k-means clustering function. I then used each color to mask off a segment of the image to be shaded with a pen of a different color.\r\n    \u003C/p>\r\n\u003C/div>"}</script>
	<script type="application/json" data-sveltekit-fetched data-url="/card2022/desc/6_shading_masks.html">{"status":200,"statusText":"","headers":{},"body":"\u003Cdiv class=\"indented\">\r\n    \u003Cp>\r\n        The dark \"outline\" segment was discarded, and the blue parts of the foreground manually combined with the grey to give a single \"ground\" segment.  \r\n        \u003Cbr/>\r\n        I also masked the segments near the outline vectors to help prevent overlap due to imprecise plotting.\r\n    \u003C/p>\r\n\u003C/div>"}</script>
	<script type="application/json" data-sveltekit-fetched data-url="/card2022/desc/7_all_hatched.html">{"status":200,"statusText":"","headers":{},"body":"\u003Cdiv class=\"indented\">\r\n    \u003Cp>\r\n        Finally, the raster segments were vectorized with the \u003Ca href=\"https://github.com/plottertools/hatched\">\u003Cspan class=\"code\">hatched\u003C/span> package\u003C/a>\r\n        \u003Cbr/>\r\n        The concentric circular hatching offered by that tool reminded me of the star trails created by long exposure night photography, so I chose to use that for the sky.\r\n    \u003C/p>\r\n\u003C/div>"}</script>
	<script type="application/json" data-sveltekit-fetched data-url="/card2022/desc/8_plotting.html">{"status":200,"statusText":"","headers":{},"body":"\u003Ch3>Plotting It All Together \u003Cspan style=\"font-size: 0.78em; font-weight: 400;\">(Ahaha.)\u003C/span>\u003C/h3>\r\n\u003Cp>\r\n    That's it! Here's the combined SVG plotted to the card. I removed the stars/snowflakes (I don't think the model could decide what they were) from the outline layer as they were too small to plot effectively and just added confusion to the sky.\r\n\u003C/p>\r\n\u003Cp>\r\n    This SVG was combined with the \"Merry Christmas\" text in Inkscape and converted to gcode with the \u003Ca href=\"https://github.com/plottertools/vpype-gcode\">\u003Cspan class=\"code\">vpype-gcode\u003C/span>\u003C/a> plugin for vpype.  \r\n    \u003Cbr/>\r\n    I then went in and manually broke the gcode up into four files for more flexibility when plotting.\r\n\u003C/p>"}</script></div>
	</body>
</html>
